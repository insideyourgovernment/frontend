<html>
<head>
<title>Inside Your Government</title>
<link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700' rel='stylesheet' type='text/css'>
<style>
html, body, div, span, applet, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, sup, tt, var,
b, u, i, center,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed, 
figure, figcaption, footer, header, hgroup, 
menu, nav, output, ruby, section, summary,
time, mark, audio, video {
	margin: 0;
	padding: 0;
	border: 0;
	font-size: 100%;
	font: inherit;
	vertical-align: baseline;
}
/* HTML5 display-role reset for older browsers */
article, aside, details, figcaption, figure, 
footer, header, hgroup, menu, nav, section {
	display: block;
}
body {
	line-height: 1;
}
ol, ul {
	list-style: none;
}
blockquote, q {
	quotes: none;
}
blockquote:before, blockquote:after,
q:before, q:after {
	content: '';
	content: none;
}
table {
	border-collapse: collapse;
	border-spacing: 0;
}
strong {
font-weight:bold;
}
body {
background:#FFF;
line-height:1.5;
font-family: 'Merriweather', serif;
margin:0;
}
#header {
display:block;
text-decoration:none;
padding:10px 20px;
background:#000 url('/img/logo2.png') no-repeat 10px 10px;
font-family: 'Oswald', sans-serif;
color:#fff;
}
h1 {
margin-right:20px;
padding-left: 30px;
font-size:2em;
display:inline;
}
.tagline {
color:#fff;
font-size:1.5em;
font-style:italic;
}
#intro {
background:#fff600;
padding:20px;
font-size:.95em;
line-height:1.2;
}
a:hover {
text-decoration:none;
}
#allstars {
margin:0 0 20px 20px;
float:right;
width:300px;
background:#fff600 url('/img/allstars2.png') no-repeat;
padding:10px;
border-radius: 10px;
}
#allstars h3 {
padding:0 50px;
text-align:center;
}
#allstars li {
margin-bottom:10px;
}
#main {
padding:20px;
}
#nav {
background:#000;
border-bottom:1px solid #fff600;
display:block;
padding:0 20px;
}
#nav a:link, #nav a:visited
{
font-family: 'Oswald', sans-serif;
float: left;
font-weight: bold;
text-decoration: none;
color: #fff;
padding:9px 0 9px 0;
display:inline-block;
margin-right:20px;
}

#nav a.current:link, #nav a.current:visited, #nav a:hover
{
border-bottom: 4px solid #fff600;
padding-bottom: 7px;
background: transparent;
color: #fff;
}

.data_table {
  width:100%;
}
.data_table th {

font-weight:bold;
}
.data_table th, .data_table td {
font-size:.8em;
  padding:5px;
  vertical-align:top;
  text-align:left;
  border:1px solid #000;
}
.admin {
display:none;
}
.main, #working_space {
padding:20px;
}
h2 {
font-size:1.5em;
}
h3 {
font-size:1.2em;
}
h2, h3 {
font-weight:bold;
}
h2, h3, table {
margin-bottom:10px;
}
.highlight {
background:yellow;
}
</style>
<script src="https://code.jquery.com/jquery-git2.min.js"></script>
<script>
  function highlight(what, where) {
    try {  
    where.each(function() {
      $(this).html($(this).html().replace(what.not('photo'), '<span class="highlight">'+what+'</span>'));
    });
    } catch (err) {
        
    }
  }
function clone(obj) {
    if (null == obj || "object" != typeof obj) return obj;
    var copy = obj.constructor();
    for (var attr in obj) {
        if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
    }
    return copy;
}
function stringStartsWith (string, prefix) {
  return string.slice(0, prefix.length) == prefix;
}
function appendLater(what, when) {
  setTimeout(function() {$('.data_results').append(what)}, when);   
}
function addData(table, element, data) {
  element.html('');
  window.payload = data['payload'];
  //console.log('fields '+data['fields']);
  var additional = '';
  if ('has_string_in_any_field' in window.payload) {
    additional = ' mentioning "'+window.payload['has_string_in_any_field']+'"';
    setTimeout(function() {highlight(window.payload['has_string_in_any_field'], $('.data_results td'))}, 1500);
  }
  var title = data['table']['name']+additional;
  var header = '<h2>'+title+'</h2>';
  element.append(header);
  header = '';
  document.title = title + " | Inside Your Government";
  header = '<a href="#!/data/?table='+data['table']['id']+'">Link to table without any subqueries</a> ';
  header += 'Raw data in JSON format at <span class="url"></span>';
  header += '<br/><strong>Search:</strong> <input type="text" class="search_query" /><input type="button" data-table="'+data['table']['id']+'" class="go" value="go" />';
  if (data['number_of_rows'] == 1) {
    header += ' ('+data['number_of_rows']+' row)';
  } else {
    header += ' ('+data['number_of_rows']+' '+data['name_for_rows']+')';
  }
  element.append(header);
  header = '';
  $.each(data['field_selectors'], function(i, value) {
    if (value['selector'] == 'checkbox') {
        var isboth = '';
        var istrue = '';  
        var isfalse = '';   
        if ('filter' in window.payload) {
          if (value['name'] in window.payload['filter']) {

            switch(window.payload['filter'][value['name']]) {
              case true:
                  istrue = ' selected';
                  break;
              case false:
                  isfalse = ' selected';
                  break;
            }        
          }
          else {
            isboth = ' selected';
          }
        } else {
          isboth = ' selected';
        }

        header += ' <select data-field="'+value['name']+'" class="boolean_field"><option value="both"'+isboth+'>Both '+value['display_name']+' and Not '+value['display_name']+'</option><option value="true"'+istrue+'>Only '+value['display_name']+'</option><option value="false"'+isfalse+'>Only Not '+value['display_name']+'</option></select>';
    } else if (value['selector'] == 'dropdown') {
        header += ' <strong>'+value['display_name']+'</strong> <select data-field="'+value['name']+'" class="dropdown_selector">';
        
        header += '</select>';
    }
  });
  if ('percentages' in data) {
    if (data['percentages'].length > 0) {
      header += '<h3>Auto generated analysis</h3>';
      header += '<table class="data_table percentages"><tr><th>Field</th><th>Value</th><th>Percentage</th><th>Sentence</th></tr>';
      
      $.each(data['percentages'], function(i, value) {
        new_payload = clone(window.payload);
        new_payload['filter'] = {};
        new_payload['filter'][value['field']] = true;
        header += '<tr><td>'+value['field']+'</td><td><a href="/#!/data/?payload='+encodeURIComponent(JSON.stringify(new_payload))+'">'+value['value']+'</a></td><td>'+value['percentage']+'</td><td>'+value['sentence']+'</tr>';
      });
      header += '</table>';
    }
  }
  element.append(header);
  header = '';
  header += '<h3>Rankings</h3>';
  $.each(data['group_counts'], function(j, value2) {
      header += '<table class="data_table"><tr><th colspan="2">'+value2[0]+'</th></tr>';
      $.each(value2[1], function(h, value3) {
          header += '<tr><td>'+JSON.stringify(value3[0])+'</td><td>'+value3[1]+'</td></tr>';
      });
      header += '</table>';
  });
  header += '<h3>The data</h3>';
  element.append(header);
  //header = '';
  var table_html = '<table class="data_table data_results"></table>';
  element.append(table_html);
  table_html = ''
  $.each(data['data'], function(j, value2) {
    table_html += '<tr>';
    
    if ('default_fields_to_display' in data['table']) {
      var fields = data['table']['default_fields_to_display'];
    } else {
      var fields = data['fields'];
    }
    $.each(fields, function(i, value) {
      table_html += '<th>'+value+'</th>';
    });
    table_html += '</tr>';
    table_html += '<tr>';
    $.each(fields, function(h, value3) {
      if (!(value3 in value2)) {
        table_html += '<td></td>';
      } else if (value3.indexOf("photo") > -1) {
        table_html += '<td class="photo"><img src="'+value2[value3]+'" style="max-width:100px" /></td>';
      } else if (value3 == 'Summarized results') {
        var sresults = value2[value3];
        table_html += '<td><table>';
        $.each(sresults, function(eindex, employee) {
          table_html += '<tr><th colspan="2">'+employee['heading']+'</th></tr>';
          $.each(employee['allegations'], function(aindex, allegation) {
            table_html += '<tr><th>'+allegation['heading']+'</th><td>'+allegation['allegation']+'</td></tr>';
            if (stringStartsWith(allegation['opa_finding'], 'Sustained')) {
              highlighting = ' class="highlight"';
            } else {
              highlighting = '';
            }
            table_html += '<tr><th>'+allegation['heading']+' OPA finding</th><td'+highlighting+'>'+allegation['opa_finding']+'</td></tr>';
          });
          table_html += '<tr><th>Final discipline</th><td>'+employee['final_discipline']+'</td></tr>';
        });
        table_html += '</table>';
        table_html += '</td>';
      } else if (String(value2[value3]).indexOf('[object Object]') > -1) {
        table_html += '<td>'+JSON.stringify(value2[value3]).replace(/:"/g, ': "')+'</td>'; 
      } else if (value3 in value2) {
        table_html += '<td>'+value2[value3]+'</td>';
      } 
    });
    table_html += '</tr>';
    //appendLater(table_html, j*5)
    //$('.data_results').append(table_html);
    //console.log(table_html);
  });
  
  //table_html += '</table>';
  setTimeout(function() {$('.data_results').html(table_html);}, 1000);
}
function addUrl(element, url) {
  window.location.hash = '!/data/'+url.substring(45);
  //console.log('add url '+url);
  setTimeout(function() {element.find('.url').html('<a href="'+url+'">'+url+'</a>');}, 500);
}
function getData(table, element, other) {
  var params = {'table': table};
  if (other) {
    var params = other;
    params['table'] = table;
  }
  $.ajax({
      url: 'https://api.insideyourgovernment.com/retrive/',
      data: {'payload': JSON.stringify(params)},
      dataType: 'json',
      complete : function(){
        //console.log('url', this.url);
          addUrl(element, this.url);
      },
      success: function(data){
        
        addData(table, element, data);
      }
  });
}
function getDataForPayload(payload, element) {
  //console.log('type '+String(payload) == '[object Object]');
  if (String(payload) == '[object Object]') {
    $.ajax({
        url: 'https://api.insideyourgovernment.com/retrive/',
        data: {'payload': JSON.stringify(window.payload)},
        dataType: 'json',
        complete : function(){
          //console.log('url', this.url);
            addUrl(element, this.url);
        },
        success: function(data){
          var table = data['table'];
          addData(table, element, data);
          if ('payload' in data) {
            if ('has_string_in_any_field' in data['payload']) {
              setTimeout(function() {$('.search_query').val(data['payload']['has_string_in_any_field'])}, 1000);
            }
          }
        }
    });
    
  } else {
    $.ajax({
        url: 'https://api.insideyourgovernment.com/retrive/?payload='+payload,
        
        dataType: 'json',
        complete : function(){
          //console.log('url', this.url);
            addUrl(element, this.url);
        },
        success: function(data){
          var table = data['table'];
          addData(table, element, data);
          if ('payload' in data) {
            if ('has_string_in_any_field' in data['payload']) {
              setTimeout(function() {$('.search_query').val(data['payload']['has_string_in_any_field'])}, 500);
            }
          }
        }
    });
  }
}
String.prototype.endsWith = function(suffix) {
  return this.indexOf(suffix, this.length - suffix.length) !== -1;
};
function processHash() {
  setTimeout(function() {
    $('#share_buttons #facebook').html("<div class=\"fb-share-button\" data-href=\""+window.location+" data-layout=\"button\"><\/div>");
    $('#share_buttons #twitter').html("<a href=\"https:\/\/twitter.com\/share\" class=\"twitter-share-button\"{count} data-size=\"large\">Tweet<\/a>\r\n<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=\/^http:\/.test(d.location)?\'http\':\'https\';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+\':\/\/platform.twitter.com\/widgets.js\';fjs.parentNode.insertBefore(js,fjs);}}(document, \'script\', \'twitter-wjs\');<\/script>");
  }, 1000);
  var hash = window.location.hash;
  if (hash) {
    if (hash.endsWith('/')) {
      hash = hash.slice(3,-1);
    } else {
      hash = hash.slice(3);         
    }
    //console.log(hash);
    $('.main').hide();
    $('#nav a').removeClass('current');
    $("[href='/#!/"+hash+"/']").addClass('current');
    //console.log('substring '+hash.substring(0, 11));
    $('#working_space').text('');
    if (hash.substring(0, 9) == 'articles/') {
        //console.log('next substring '+hash.substring(9));
        $('#'+hash.substring(9)+'_article').show();
        document.title = $('#'+hash.substring(9)+'_article h2').text() + ' | Inside Your Government';
        gaTrack(window.location.hash.substring(2), document.title + ' | Inside Your Government');
        DISQUS.reset({
          reload: true,
          config: function () {  
            this.page.identifier = hash.substring(9);  
            this.page.url = window.location;
          }
        });
    } else if (hash.substring(0, 12) == 'data/?table=') {
        var table = hash.substring(12);
        //console.log(table);
        getData(table, $('#working_space'));
        DISQUS.reset({
          reload: true,
          config: function () {  
            this.page.identifier = hash.substring(9);  
            this.page.url = window.location;
          }
        });
    } else if (hash.substring(0, 14) == 'data/?payload=') {
        var payload = hash.substring(14);
        //console.log(table);
        getDataForPayload(payload, $('#working_space'));
        setTimeout(function() {DISQUS.reset({
          reload: true,
          config: function () {  
            this.page.identifier = hash.substring(9);  
            this.page.url = window.location;
          }
        })}, 1000);
    } else {
        document.title = $('#'+hash+'_main h2').text() + ' | Inside Your Government';
        gaTrack(window.location.hash.substring(2), document.title + ' | Inside Your Government');
        $('#'+hash+'_main').show();
        
    }    
    
  } else {
    window.location.hash = '#!/home/';
    processHash();
  }
}

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i=0; i<ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1);
        if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
    }
    return "";
}

// Function to load and initiate the Analytics tracker
function gaTracker(id){
  $.getScript('//www.google-analytics.com/analytics.js'); // jQuery shortcut
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', id, 'auto');
  ga('send', 'pageview');
}


// Function to track a virtual page view
function gaTrack(path, title) {
  ga('set', { page: path, title: title });
  ga('send', 'pageview');
}


$(function() {
  $('#nav').height($('#nav a:link').outerHeight()+2);
  gaTracker('UA-70789642-1');
  $('#account_box').hide();
  $('.main').not('#home').hide();
  processHash();
  //$('ul'+hash+':first').show();
  $('body').on('click', 'a', function() {
    //console.log($(this).attr('href').substring(0, 1));
    if ($(this).attr('href').substring(0, 3) == "/#!" || $(this).attr('href').substring(0, 2) == "#!") {
      setTimeout(function(){processHash();},100);
    }
  });
  //console.log(document.cookie);
  //console.log(getCookie('session'));
  $.get('https://api.insideyourgovernment.com/get_session_info/', {'session': getCookie('session')}, function(data) {
      //console.log(data);
      $('#login_box').hide();
      $('#account_box').show(); 
      if (data['is_admin']) {
        $('.admin').show();
        $.get('https://api.insideyourgovernment.com/tables/', function(data) {
           $.each(data, function(i, value) {
             $('#tables_for_action').append('<option value="'+value+'">'+value+'</option>');
           });           
        });
      }
    }); 
  $('#login').click(function() {
    $.post('https://api.insideyourgovernment.com/login/', {'email': $('#email').val(), 'password': $('#password').val()}, function(data) {
        //console.log(typeof data);
        //console.log(data['session_id']);
      document.cookie="session="+data['session_id'];
      //console.log(document.cookie);
      //console.log(data);  
    });  
  });
  $.fn.getAttributes = function() {
    var attributes = {}; 
    if( this.length ) {
        $.each( this[0].attributes, function( index, attr ) {
            if (attr.name.substring(0,5) == 'data-') {
              if (attr.name == 'data-pluck') {
                attributes[ attr.name.slice(5) ] = JSON.parse(attr.value);
              } else {
                attributes[ attr.name.slice(5) ] = attr.value;
              }
            } else {
              attributes[ attr.name ] = attr.value;
            }
        } ); 
    }
    return attributes;
  };
  function addDivsOfTables(theObj, data) {
    //theObj.html(JSON.stringify(data));
    $.each(data['keys'], function(i, value) {
      var table = '<table class="data_table">';
      table += '<tr><th>Link</th>';
      $.each(data['table_fields'], function(j, value2) {
        table += '<th>'+value2+'</th>';
      });
      //console.log(value+' '+JSON.stringify(data[value]));
      $.each(data['data'][value], function(j, value2) {
        table += '<tr>';
        table += '<td><a href="/#!/data/?table='+value2[theObj.attr('data-field_for_url')]+'">'+value2[theObj.attr('data-field_to_name_link')]+'</a>';
        $.each(data['table_fields'], function(h, value3) {
          table += '<td>'+value2[value3]+'</td>';
        });
        table += '</tr>';
      });
      table += '</tr>';
      table += '</table>';
      theObj.append('<div class="box_200"><h3>'+value+'</h3>'+table+'</div>');
    });
  }
  function getDivsOfTables(theObj) {
    var params = theObj.getAttributes();
    
    $.get('https://api.insideyourgovernment.com/retrive/', {'payload': JSON.stringify(params)}, function(data) {
      //console.log(data);
      addDivsOfTables(theObj, data);
    });
  }
  $('.divs_of_tables').each(function() {
    getDivsOfTables($(this));
  });

  $('body').on('click', '.go', function() {
    var query = $(this).prev().val();
    getData($(this).attr('data-table'), $('#working_space'), {'has_string_in_any_field': query});
    setTimeout(function() {$('.search_query').val(query)}, 1000);
    setTimeout(function() {highlight($('.search_query').val(), $('#working_space td').not('.photo'))}, 1000);
  });
  $("body").on('keyup', '.search_query', function (e) {
    if (e.keyCode == 13) {
        $(this).parent().find('.go').trigger('click');
    }
  });
  $('body').on('change', '.boolean_field', function(e) {
    var f = $(this).attr('data-field');
    window.payload['filter'] = {};
    //console.log(JSON.stringify(window.payload));
    if ($(this).val() == 'both') {
      if ('filter' in window.payload) {
        if ($(this).attr('data-field') in window.payload['filter']) {
          delete window.payload['filter'][$(this).attr('data-field')];
        }
        if (Object.keys(window.payload['filter'])) {
          delete window.payload['filter'];
        }
      }      
    } else {
      //console.log($(this).val(), Boolean($(this).val()));
      window.payload['filter'][f] = ($(this).val() == 'true');
    }
    getDataForPayload(window.payload, $('#working_space'));
    
  });
});
</script>
</head>
<body>
<a href="/#!/home/" id="header">
<h1>Inside Your Government</h1>

</a>
<div id="intro">
<strong>The mission:</strong> To make government transparent by default and to do as much <strong style="font-style:italic">good</strong> with that transparency as possible.

</div>
<ul id="nav">
<li><a href="/#!/about/" data-id="about">About Inside Your Government</a></li>
<li><a href="/#!/data/" data-id="data">Open Data</a></li>
<li><a href="/#!/thoughts/" data-id="News">My Thoughts</a></li>
<li><a href="/#!/get_involved/" data-id="get_involved">Get Involved</a></li>
</ul>
<p style="margin:20px 20px 0 20px;"><strong>Attention:</strong> This site is in the early stages of being developed. Contact Tim Clemans at <a href="mailto:tim@insideyourgovernment.com">tim@insideyourgovernment.com</a> for more information. Developmnet activity log is at <a href="https://docs.google.com/spreadsheets/d/1qYpbFjDn3bmTEPjIlqaBEmduUea0-PLSBgQy9HqEsFw/edit#gid=0&vpid=A1">https://docs.google.com/spreadsheets/d/1qYpbFjDn3bmTEPjIlqaBEmduUea0-PLSBgQy9HqEsFw/edit#gid=0&vpid=A1</a>  Some of the data takes about 20 seconds to load. Most of the pages have no content yet.</p>
<div id="home_main" class="main">

<div id="allstars">
<h3>Government Transparency All Stars</h3>
<ul>
<li><strong>New York City:</strong> By local law each city entity is to publish all of its digital public data by 2018. </li>
<li><strong>Seattle Police Department:</strong> Posted on Youtube dash camera videos of three officer-involved shootings on the same day of the shootings.</li>

<li><strong>King County Sheriff's Office:</strong> Released a spreadsheet of over 12 thousand employee actions including alleged misconduct with names in just 11 calendar days.</li>
<li><strong>City of Redmond:</strong> Publishes money spent.</li>

</ul>
</div><h2>Home</h2>
</div>
<div class="main" id="about_main"><h2>About Inside Your Government</h2></div>
<div class="main" id="data_main"><h2>Open Data</h2>

<div id="data_admin" class="admin"><strong>Action:</strong> 
<select id="data_admin_action">
<option></option>
<option value="table_create">Table create</option>
<option value="insert">Insert</option>
<option value="update">Update</option>
</select>
<strong>Table name:</strong> <input type="text" id="table_name_for_action" /> 
<strong>Table:</strong> <select id="tables_for_action">
<option></option>
</select>
<strong>Dictionary:</strong> <input type="text" id="dictionary_for_action" />
<input type="button" value="Run" />
</div>

<div class="divs_of_tables" data-action="do_row_mapping" data-table="tables" data-field_for_key="categories" data-field_for_url="id" data-field_to_name_link="name"></div>

</div>
<div class="main" id="just_the_facts_main"><h2>Just the Facts</h2></div>
<div class="main" id="thoughts_main"><h2>My Thoughts</h2></div>
<div class="main" id="get_involved_main"><h2>Get Involved</h2></div>
<div id="working_space"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = 'https://insideyourgovernment.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> 
<div id="disqus_thread" style="width:50%; margin:10px 20px;"></div>
</div>
</body>
</html>
